name: Publish to NuGet

on:
  release:
    types: [published]

permissions:
  id-token: write  # Required for Trusted Publishing (OIDC)
  contents: read   # Required to checkout code

jobs:
  publish:
    name: Publish
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: 8.0.x

    # We rebuild to ensure the exact commit matches the tag
    - name: Pack
      run: |
        dotnet restore Sannr.sln
        dotnet build Sannr.sln --configuration Release
        
        # Versioning: You might want to use the tag name here (e.g., 1.0.0)
        VERSION=${{ github.event.release.tag_name }}
        # Remove 'v' prefix if present (e.g. v1.0.0 -> 1.0.0)
        VERSION=${VERSION#v}
        
        echo "ðŸ“¦ Packing Version: $VERSION"
        
        # ONLY pack the main project now. It handles bundling Core and Gen automatically.
        dotnet pack src/Sannr.AspNetCore/Sannr.AspNetCore.csproj -c Release -o out /p:Version=$VERSION

    - name: Push to NuGet (Trusted Publishing)
      run: dotnet nuget push "./out/*.nupkg" --source https://api.nuget.org/v3/index.json --api-key ${{ secrets.NUGET_API_KEY }}
      # Note: If using strict OIDC without ANY keys, you would use --interactive methods, 
      # but standard Trusted Publishing usually maps an OIDC token to a short-lived API key 
      # internally or validates the token directly. 
      #
      # HOWEVER: The simplest "Trusted Publishing" setup currently provided by NuGet 
      # still recommends passing the key if you aren't using the specialized action, 
      # BUT the modern way is to just let the environment handle it if you configured OIDC correctly.
      # 
      # Let's support the Standard API Key fallback for simplicity if OIDC setup is skipped:
      env:
        NUGET_AUTH_TOKEN: ${{ secrets.NUGET_API_KEY }}
