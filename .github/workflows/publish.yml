name: Publish to NuGet

on:
  release:
    types: [published]

permissions:
  id-token: write  # Required for Trusted Publishing (OIDC)
  contents: read   # Required to checkout code

jobs:
  publish:
    name: Publish
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: 8.0.x

    # We rebuild to ensure the exact commit matches the tag
    - name: Pack
      run: |
        dotnet restore Sannr.sln
        dotnet build Sannr.sln --configuration Release
        
        # Versioning: You might want to use the tag name here (e.g., 1.0.0)
        VERSION=${{ github.event.release.tag_name }}
        # Remove 'v' prefix if present (e.g. v1.0.0 -> 1.0.0)
        VERSION=${VERSION#v}
        
        echo "ðŸ“¦ Packing Version: $VERSION"
        
        # ONLY pack the main project now. It handles bundling Core and Gen automatically.
        dotnet pack src/Sannr.AspNetCore/Sannr.AspNetCore.csproj -c Release -o out /p:Version=$VERSION

    - name: Push to NuGet (Trusted Publishing)
      run: dotnet nuget push "./out/*.nupkg" --source https://api.nuget.org/v3/index.json --skip-duplicate
      # Uses Trusted Publishing with OIDC - no API key needed!
      # The id-token: write permission above enables this secure authentication
